name: release-beta

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_tests:
        description: Run swift tests before release
        required: true
        default: true
        type: boolean

permissions:
  contents: write

concurrency:
  group: release-beta-main
  cancel-in-progress: false

jobs:
  release:
    if: github.ref == 'refs/heads/main'
    runs-on: macos-14
    env:
      APP_BUNDLE_ID: ${{ vars.APP_BUNDLE_ID }}
      APP_NAME: Typist
      APP_EXECUTABLE: TypistMenuBar
      BASE_BETA_VERSION: 0.1.0
      TAP_REPO: ${{ vars.TAP_REPO }}
      TAP_DEFAULT_BRANCH: ${{ vars.TAP_DEFAULT_BRANCH }}
      SOURCE_REPO: ${{ github.repository }}
      APPLE_DEVELOPER_ID_CERT_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_CERT_P12_BASE64 }}
      APPLE_DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERT_PASSWORD }}
      DEVELOPER_ID_APPLICATION: ${{ secrets.DEVELOPER_ID_APPLICATION }}
      APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
      APPLE_API_PRIVATE_KEY_P8: ${{ secrets.APPLE_API_PRIVATE_KEY_P8 }}
      TAP_REPO_TOKEN: ${{ secrets.TAP_REPO_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tag history is present
        run: git fetch --tags --force

      - name: Run tests
        if: github.event_name != 'workflow_dispatch' || inputs.run_tests
        run: swift test

      - name: Resolve next release version
        id: version
        run: |
          current_max="$(git tag --list "v${BASE_BETA_VERSION}-beta.*" | awk -F'.beta.' '/^v[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+$/ {print $2}' | sort -n | tail -n 1)"
          if [[ -z "$current_max" ]]; then
            next_number=1
          else
            next_number=$((current_max + 1))
          fi
          next_version="${BASE_BETA_VERSION}-beta.${next_number}"
          echo "version=$next_version" >> "$GITHUB_OUTPUT"

      - name: Build app bundle
        run: scripts/release/build_app_bundle.sh "${{ steps.version.outputs.version }}" "${{ github.run_number }}" dist

      - name: Build DMG
        run: scripts/release/create_dmg.sh "${{ steps.version.outputs.version }}" dist

      - name: Sign and notarize DMG
        if: env.APPLE_DEVELOPER_ID_CERT_P12_BASE64 != '' && env.APPLE_DEVELOPER_ID_CERT_PASSWORD != '' && env.APPLE_API_KEY_ID != '' && env.APPLE_API_ISSUER_ID != '' && env.APPLE_API_PRIVATE_KEY_P8 != ''
        run: scripts/release/sign_and_notarize.sh "dist/Typist.app" "dist/Typist-${{ steps.version.outputs.version }}.dmg"

      - name: Skip notarization (credentials missing)
        if: env.APPLE_DEVELOPER_ID_CERT_P12_BASE64 == '' || env.APPLE_DEVELOPER_ID_CERT_PASSWORD == '' || env.APPLE_API_KEY_ID == '' || env.APPLE_API_ISSUER_ID == '' || env.APPLE_API_PRIVATE_KEY_P8 == ''
        run: echo "Apple signing/notarization secrets are missing; publishing unsigned DMG."

      - name: Publish prerelease
        run: |
          version="${{ steps.version.outputs.version }}"
          latest_tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          unsigned_note="⚠️ This build is unsigned and not notarized. If macOS blocks launch, right-click Typist.app and choose Open, or run: xattr -dr com.apple.quarantine /Applications/Typist.app"
          signed_note="✅ This build is signed and notarized."

          if [[ -n "${APPLE_DEVELOPER_ID_CERT_P12_BASE64}" && -n "${APPLE_DEVELOPER_ID_CERT_PASSWORD}" && -n "${APPLE_API_KEY_ID}" && -n "${APPLE_API_ISSUER_ID}" && -n "${APPLE_API_PRIVATE_KEY_P8}" ]]; then
            security_note="$signed_note"
          else
            security_note="$unsigned_note"
          fi

          release_note_block="$security_note"$'\n\n'"Homebrew installs the same artifact and does not add notarization trust."
          release_args=(
            "v${version}"
            "dist/Typist-${version}.dmg"
            --repo "${{ github.repository }}"
            --target "${{ github.sha }}"
            --title "Typist v${version}"
            --generate-notes
            --notes "$release_note_block"
            --prerelease
          )

          if [[ -n "$latest_tag" ]]; then
            release_args+=(--notes-start-tag "$latest_tag")
          fi

          gh release create "${release_args[@]}"

      - name: Compute DMG SHA256
        id: checksum
        run: |
          sha="$(scripts/release/compute_sha256.sh "dist/Typist-${{ steps.version.outputs.version }}.dmg")"
          echo "sha=$sha" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew tap
        if: env.TAP_REPO != '' && env.TAP_REPO_TOKEN != ''
        run: scripts/release/update_tap_repo.sh "${{ steps.version.outputs.version }}" "${{ steps.checksum.outputs.sha }}"
